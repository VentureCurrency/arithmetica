<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Arithmetica</title>
    <link id="favicon" rel="shortcut icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAatJREFUeNqsV8tRxDAMDZ8D3FxCSsiRG9BB6CB0kBJCBVtC6GChgsCNW7aDLBV4uXEL9ox2Jnhs6fmjGc3OrC35SXrSaqvKL7VRbXRX4TKRFhHraDW6gPcbum91TwEky9aZ1Q6wGRybM/iR7FUMANeZBiLaeQC4PryBXAKAFKVVZWRVUTbqFADnsnAE+wH9tAiAIwNiDJy9RWQCuqSZeoZacxR4sBK//smVx9Gv0VujD4GH7ox+Gz04378bvaBM3QRs7Z0vlDizEE3LZHDZsH+irPWxRN46CrVW47HruJSnDCUtgHCjWiKnaDaIeQOii5ygcCkmgQ+T8xuiS0a/AO21Om24L/F466R+BHu9CPlq5/Ehd+Ck7gM+NitgRsy50fsIFjMjVmaSitJ7FotSMyJpIeF6ugFKoUoA4LaiDpwRsHQJ0QzAjEgmIepIas82BgTXZj3YvitI5ui6cuyWZgScBSWks09c6QZ0Kz4Z/WAeuWfOrO0jfYrCreWfGdut3RefcwAoIUpE7Kr+4gEGiTTnY7YdzXXBdcDoGPiDcqLSvEZmwrL/yXf4J8AAXQU9IArb8UMAAAAASUVORK5CYII=">

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <script src='src/app.js'></script>
    <link rel='stylesheet' type='text/css' href='css/app.css'>
    
  </head>

  <body>
      <nav class="navbar navbar-expand-md navbar-light">
      <img id="logo" draggable="false" src="data:image/svg+xml,%3C%3Fxml%20version%3D%221.0%22%20encoding%3D%22utf-8%22%3F%3E%0A%3C%21--%20Generator%3A%20Adobe%20Illustrator%2021.0.1%2C%20SVG%20Export%20Plug-In%20.%20SVG%20Version%3A%206.00%20Build%200%29%20%20--%3E%0A%3Csvg%20version%3D%221.1%22%20id%3D%22Layer_1%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20xmlns%3Axlink%3D%22http%3A//www.w3.org/1999/xlink%22%20x%3D%220px%22%20y%3D%220px%22%0A%09%20viewBox%3D%220%200%20140.2%20140.2%22%20style%3D%22enable-background%3Anew%200%200%20140.2%20140.2%3B%22%20xml%3Aspace%3D%22preserve%22%3E%0A%3Cstyle%20type%3D%22text/css%22%3E%0A%09.st0%7Bfill%3A%23FFFFFF%3B%7D%0A%3C/style%3E%0A%3Cg%3E%0A%09%3Cpath%20class%3D%22st0%22%20d%3D%22M22.8%2C138.8c-11.8%2C0-21.4-9.6-21.4-21.4V22.8C1.4%2C11%2C11%2C1.4%2C22.8%2C1.4h94.6c11.8%2C0%2C21.4%2C9.6%2C21.4%2C21.4v94.6%0A%09%09c0%2C11.8-9.6%2C21.4-21.4%2C21.4H22.8z%22/%3E%0A%09%3Cpath%20d%3D%22M117.4%2C2.8c11%2C0%2C20%2C9%2C20%2C20v94.6c0%2C11-9%2C20-20%2C20H22.8c-11%2C0-20-9-20-20V22.8c0-11%2C9-20%2C20-20H117.4%20M117.4%2C0H22.8%0A%09%09C10.2%2C0%2C0%2C10.2%2C0%2C22.8v94.6c0%2C12.6%2C10.2%2C22.8%2C22.8%2C22.8h94.6c12.6%2C0%2C22.8-10.2%2C22.8-22.8V22.8C140.2%2C10.2%2C130%2C0%2C117.4%2C0L117.4%2C0z%22%0A%09%09/%3E%0A%3C/g%3E%0A%3Cg%3E%0A%09%3Cg%3E%0A%09%09%3Cpath%20class%3D%22st0%22%20d%3D%22M90.1%2C113.5v-2.1c0-2.3-1.2-4.9-3.7-7.7l-29-33.5c-2.9%2C1.8-4.2%2C3.9-4.2%2C6.5c0%2C1.3%2C0.3%2C2.5%2C1%2C3.6%0A%09%09%09c0.5%2C1%2C2.4%2C3.6%2C8.2%2C10.7l0.1%2C0.1l0%2C0.1c2.5%2C3.7%2C3.8%2C7.5%2C3.8%2C11.5c0%2C8.4-5%2C9.6-8%2C9.6H39.7v-6.3l1.5-0.5c2.7-0.8%2C2.7-2.2%2C2.7-2.8%0A%09%09%09c0-0.4-0.3-2.3-3.8-11.7l0-0.1c-1-3-1.5-5.7-1.5-7.9c0-7.9%2C4.2-14.6%2C12.4-19.9l-6.4-7.2C40.5%2C51%2C38.4%2C46%2C38.4%2C41%0A%09%09%09c0-4.8%2C2-9.4%2C5.9-13.6l0.6-0.7h5.2v2.1c0%2C2.7%2C1.2%2C5.5%2C3.7%2C8.4l22.9%2C26.2c1-3%2C2.6-6.3%2C4.7-9.7c-6.3-2.2-9.5-7.2-9.5-14.5%0A%09%09%09c0-4.4%2C1.2-8.4%2C3.7-11.7l0.6-0.9h4.5l0.3%2C1.8c0.2%2C1.1%2C0.9%2C2.8%2C4.6%2C3.7l6%2C1.4c3.2%2C0.8%2C5.7%2C2.2%2C7.4%2C4.1c1.8%2C2%2C2.7%2C5%2C2.7%2C9.1%0A%09%09%09c0%2C2.6-0.3%2C4.7-0.9%2C6.3l-0.4%2C1l-1%2C0.3c-2.2%2C0.7-4.9%2C1.1-7.8%2C1.2c-0.8%2C1.3-1.6%2C2.7-2.4%2C4.4l-0.9%2C1.7c-1.4%2C2.8-2.1%2C5.6-2.1%2C8.2%0A%09%09%09c0%2C3%2C1%2C5.5%2C3%2C7.8l6.5%2C7.5c4.1%2C4.7%2C6.2%2C9.7%2C6.2%2C14.8c0%2C5-2%2C9.3-6%2C13l-0.6%2C0.6H90.1z%22/%3E%0A%09%09%3Cpath%20d%3D%22M78.8%2C28.9c0.4%2C2.7%2C2.5%2C4.5%2C6.2%2C5.4l6%2C1.4c2.8%2C0.7%2C4.9%2C1.8%2C6.3%2C3.4c1.4%2C1.6%2C2.1%2C4.1%2C2.1%2C7.6c0%2C2.3-0.3%2C4.2-0.8%2C5.6%0A%09%09%09c-2.3%2C0.7-5.1%2C1.1-8.4%2C1.1c-1.1%2C1.5-2.1%2C3.4-3.2%2C5.6l-0.9%2C1.6c-1.6%2C3.2-2.4%2C6.3-2.4%2C9.2c0%2C3.5%2C1.2%2C6.6%2C3.6%2C9.2l6.5%2C7.5%0A%09%09%09c3.8%2C4.4%2C5.7%2C8.8%2C5.7%2C13.4c0%2C4.4-1.8%2C8.1-5.3%2C11.4h-2.1c0-2.8-1.4-5.8-4.2-9.1L57.8%2C67.5c-4.6%2C2.3-6.8%2C5.3-6.8%2C9.2%0A%09%09%09c0%2C1.6%2C0.4%2C3.2%2C1.3%2C4.7c0.8%2C1.5%2C3.6%2C5.1%2C8.4%2C11c2.3%2C3.3%2C3.4%2C6.8%2C3.4%2C10.3c0%2C5-2%2C7.5-5.9%2C7.5H41.8v-2.6c2.8-0.8%2C4.2-2.5%2C4.2-4.9%0A%09%09%09c0-1.3-1.3-5.4-4-12.5c-0.9-2.8-1.4-5.2-1.4-7.2c0-7.8%2C4.5-14.3%2C13.5-19.4l-8-9.1c-3.8-4.4-5.7-8.8-5.7-13.4%0A%09%09%09c0-4.3%2C1.8-8.3%2C5.3-12.1H48c0%2C3.2%2C1.4%2C6.5%2C4.2%2C9.8l25.5%2C29.2c0.9-4.5%2C3.2-9.6%2C7-15.4C77.5%2C51.1%2C74%2C46.7%2C74%2C39.3%0A%09%09%09c0-4%2C1.1-7.5%2C3.3-10.4H78.8%20M82.5%2C24.6h-3.6h-1.6h-2.2l-1.3%2C1.7c-2.7%2C3.7-4.1%2C8.1-4.1%2C12.9c0%2C7.3%2C3%2C12.6%2C8.6%2C15.5%0A%09%09%09c-0.9%2C1.6-1.7%2C3.1-2.3%2C4.7L55.4%2C35.9c-2.1-2.5-3.2-4.8-3.2-7v-4.3H48h-2.1H44L42.8%2C26c-4.3%2C4.6-6.5%2C9.6-6.5%2C15%0A%09%09%09c0%2C5.6%2C2.3%2C11%2C6.7%2C16.2l4.8%2C5.4C40.2%2C68%2C36.4%2C74.9%2C36.4%2C82.8c0%2C2.5%2C0.5%2C5.3%2C1.6%2C8.5l0%2C0.1l0%2C0.1c3.2%2C8.4%2C3.6%2C10.6%2C3.7%2C11.1%0A%09%09%09c0%2C0.1%2C0%2C0.1%2C0%2C0.1c0%2C0%2C0%2C0%2C0%2C0c0%2C0-0.3%2C0.3-1.2%2C0.5l-3%2C0.9v3.2v2.6v4.3h4.3h16.3c2.4%2C0%2C10.1-0.8%2C10.1-11.7%0A%09%09%09c0-4.4-1.4-8.6-4.2-12.7L64%2C89.8l-0.1-0.1c-6-7.4-7.6-9.7-8-10.4c-0.5-0.8-0.7-1.7-0.7-2.6c0-0.6%2C0-2%2C1.8-3.6l27.8%2C32%0A%09%09%09c2.1%2C2.4%2C3.2%2C4.6%2C3.2%2C6.3v4.3h4.3h2.1H96l1.2-1.1c4.5-4.1%2C6.7-8.9%2C6.7-14.5c0-5.6-2.3-11-6.7-16.2l-6.5-7.5l0%2C0l0%2C0%0A%09%09%09c-1.7-1.9-2.5-4-2.5-6.4c0-2.3%2C0.6-4.7%2C1.9-7.3l0.8-1.5l0.1-0.1l0-0.1c0.6-1.2%2C1.2-2.3%2C1.7-3.2c2.7-0.2%2C5.1-0.6%2C7.3-1.2l1.9-0.6%0A%09%09%09l0.7-1.9c0.7-1.9%2C1.1-4.2%2C1.1-7.1c0-4.6-1.1-8.1-3.2-10.5c-2-2.2-4.8-3.8-8.4-4.7l0%2C0l0%2C0l-6-1.4c-2.8-0.7-2.9-1.6-3-1.9%0A%09%09%09L82.5%2C24.6L82.5%2C24.6z%22/%3E%0A%09%3C/g%3E%0A%3C/g%3E%0A%3C/svg%3E%0A"/>
        <a class="navbar-brand" href="#">Arithmetica</a>
        <button class="navbar-toggler p-0 border-0" type="button" data-toggle="offcanvas">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="navbar-collapse offcanvas-collapse" id="navbarsExampleDefault">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="dropdown01" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Contribute</a>
              <div id="problem-dropdown-menu" class="dropdown-menu" aria-labelledby="dropdown01">
                <!-- Dynamically Generated by Grabbing Problems from Blockchain -->
              </div>
            </li>
          </ul>
          <button id="add-problem-button" class="btn btn-outline-secondary my-2 my-sm-0 new-problem">+ Problem</button>
        </div>
      </nav>

    <div id="problem-name-container" class="input-group mb-3">
      <div class="input-group-prepend">
        <span class="input-group-text" id="basic-addon3">Problem Name</span>
      </div>
      <input id="problem-name" type="text" class="form-control" id="basic-url" aria-describedby="basic-addon3">
    </div>

    <div id="submit-problem-ui">
      <div id="evaluation-input-container">
        <div class="input-group-prepend">
          <span id="evaluation-label" class="input-group-text" id="basic-addon3">Evaluation</span>
        </div>
        <div id="evaluation-input"></div>
      </div>
      <div id="assertion-input-container">

        <div class="input-group-prepend">
          <span id="assertion-label" class="input-group-text" id="basic-addon3">Assertion</span>
        </div>
        <div id="assertion-input"></div>
        <button id="submit-problem" type="button" class="btn btn-outline-secondary btn-lg btn-block">Submit Problem</button>
      </div>
    </div>

    <div id="contribute-problem-ui">
        <div class="input-group-prepend">
          <span id="evaluation-label" class="input-group-text" id="basic-addon3">Peers</span>
        </div>

        <div class="scroll-table">
          <table class="table">
            <thead>
              <tr>
                <th>#</th>
                <th>ID</th>
                <th>Role</th>
                <th>Current Submission</th>
              </tr>
            </thead>
            <tbody id="participant-table-body">
            </tbody>
          </table>
        </div>
        <div class="plots">
          <div class="plot-title plot-left"><h3>Submission Rate</h3>
          <div id="submissionsChart"></div>
          </div>
          <div class="plot-title plot-right"><h3>Number of Iterations</h3>
          <div id="iterationsChart"></div>
          </div>
        </div>
        <script type="text/javascript">
        var _steps = -1;
        var _totalSubmissions = 0;
        var _rebuildTable = false;
        var _leadPeer = '';
        var _id = '';

        var submissionsContainer = document.getElementById('submissionsChart');
        var submissionsChartOptions = {
            min: 0,
            start: 0,
            end: 1,
            showCurrentTime: false,
            showMajorLabels: false,
            dataAxis: {
                left: {
                  title:{
                    text: 'Submissions'
                  }
                }
            },
            format: {
              minorLabels: {
                  millisecond: 'x',
                  second: 'x',
                  minute: 'x',
                  hour: 'x',
                  weekday: 'x',
                  day: 'x',
                  month: 'x',
                  year: 'x'
              },
              majorLabels: {
                  millisecond: '',
                  second: '',
                  minute: '',
                  hour: '',
                  weekday: '',
                  day: '',
                  month: '',
                  year: ''
              }
            },
            sort: false,
            sampling:false,
            style:'line',
            zoomable: false,
            moveable: false,
            drawPoints: {
                enabled: false,
                size: 6,
                style: 'circle' // square, circle
            },
            height: '400px'
        };

        var submissionsData=[];
        //for(var i = 0; i < 1; i++){
        //  submissionsData.push({x:i,y:10});
        //}


        var submissionsChart = new vis.Graph2d(submissionsContainer, submissionsData, submissionsChartOptions);


        var iterationsContainer = document.getElementById('iterationsChart');
        var iterationsData = [];
        var iterationsChartOptions = {
            min:0,
            start: 0,
            end: 1,
            showCurrentTime: false,
            showMajorLabels: false,
            dataAxis: {
                left: {
                  title:{
                    text: 'Iterations'
                  },
                  range: {
                    min: 0
                  }
                }
            },
            format: {
              minorLabels: {
                  millisecond: 'x',
                  second: 'x',
                  minute: 'x',
                  hour: 'x',
                  weekday: 'x',
                  day: 'x',
                  month: 'x',
                  year: 'x'
              },
              majorLabels: {
                  millisecond: '',
                  second: '',
                  minute: '',
                  hour: '',
                  weekday: '',
                  day: '',
                  month: '',
                  year: ''
              }
            },
            sort: false,
            sampling:false,
            style:'points',
            zoomable: false,
            moveable: false,
            drawPoints: {
                enabled: true,
                size: 6,
                style: 'circle' // square, circle
            },
            defaultGroup: 'Scatterplot',
            height: '400px'
        };
        var iterationsChart = new vis.Graph2d(iterationsContainer, iterationsData, iterationsChartOptions);
  
        function workerEvent(eventName, data){
          if(eventName == 'CompletedWork'){
              _totalSubmissions += 1;
              iterationsData.push({x:data.work,y:data.iterations});
              if(_rebuildTable){
                buildTable(data);
                _rebuildTable = false;
              }
              else{
                updateTableObject(data.peer, data.work);
              }
          }
          else if (eventName == 'PeerJoined'){
              addTableObject(data.peer, 0);
          }
          else if (eventName == 'PeerLeft'){
              deleteTableObject(data.peer);
          }
          else if (eventName == 'LeadPeerSelected'){
              _leadPeer = data.peer;
          }
          else if (eventName == 'InitCompleted'){
              _id = data.peer;
          }

        }


        setInterval(() => {
          _steps++;
          if(submissionsData.length > 50){
            submissionsData.shift();
          }
          //The first two time-steps have low submission rates so we filter them out
          if(_steps > 2){
            submissionsData.push({x:_steps-2,y:_totalSubmissions});
          }

          submissionsChart.setItems(submissionsData);
          submissionsChart.fit();
          _totalSubmissions = 0;
          iterationsChart.setItems(iterationsData);
          iterationsChart.fit();
          if(_steps % 10 == 0){
            _rebuildTable = true;
          }
        }, 1000)

      var participantTable = [];

      function buildTable(data){
        var tempTable = [];
        for(var i = 0; i < data.peers.length; i++){
          tempTable.push({"id": data.peers[i], "count": 0});
        }
        function compare(a, b) {
          let comparison = 0;
          if (a.id > b.id) {
            comparison = 1;
          } else if (a.id < b.id) {
            comparison = -1;
          }
          return comparison;
        }
        var tempParticipantTable = participantTable;
        tempParticipantTable.sort(compare);
        tempTable.sort(compare);
        if(!(tempParticipantTable.length==tempTable.length && tempParticipantTable.every((v,i)=> v.id == tempTable[i].id))){
          participantTable = [];
          rebuildTbody();
        }
      }

      function addTableObject(workerId, count) {
          var index = participantTable.findIndex((element) => {
              return element.id == workerId;
          });
          if(index == -1){
            participantTable.push({"id": workerId, "count": count});
            rebuildTbody();
          }
      }

      function updateTableObject(workerId, count) {
          var index = participantTable.findIndex((element) => {
              return element.id == workerId;
          });
          if( index == -1 ){
              addTableObject(workerId, count);
          }
          else{
              participantTable[index] = {"id": workerId, "count": count};
              rebuildTbody();
          }
      }

      function deleteTableObject(workerId) {
          var index = participantTable.findIndex((element) => {
              return element.id == workerId;
          });
          participantTable = participantTable.splice(index,1);
          rebuildTbody();
      }

      function rebuildTbody() {
          $("#participant-table-body").html(generateTbodyString());
      }

      function generateTbodyString() {
          let innerHTML = "";
          let myHTML = "";
          let counter = 1;
          for(let party of participantTable) {
              if(party.id === _leadPeer){
                role = 'Leader'
              }
              else{
                role = 'Worker'
              }

              if(party.id !== _id){
                innerHTML = innerHTML + "<tr> <th scope=\\\"row\\\"> Peer " + counter + "</th><td>" + party.id + "</td><td>" + role + "</td><td>" + party.count + "</td></tr>";
                counter++;
              }
              else {
                myHTML = "<tr> <th scope=\\\"row\\\"> Me </th><td>" + party.id + "</td><td>" + role + "</td><td>" + party.count + "</td></tr>";
              }
          }
          innerHTML = myHTML + innerHTML;
          return innerHTML;
      }

      </script>
    </div>
</body>
</html>

